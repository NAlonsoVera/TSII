$(function(){function u(){if(t.length===1){let i=mpolLocalStorage("mpol_carritotemporal").get();i&&i.length!==0?($("#table-cart").removeClass("hidden"),$("#vacio-carrito").hasClass("hidden")||$("#vacio-carrito").addClass("hidden"),$.ajax({url:"/Producto/ListadoFiltro",data:{productos:i},type:"POST",success:function(r){if(r){t.html("");n=r;let u=r.map(n=>n.cCodigoUno).join();fetch(`/Producto/ConsultaStock?codigoInterno=${u}`).then(n=>n.json()).then(n=>{$.each(r,function(r,u){if(i.some(n=>n.pk_eProducto==u.pk_eProducto)){let f=i.find(n=>n.pk_eProducto==u.pk_eProducto),r={};r=Array.isArray(n)?n.find(n=>u.cCodigoUno==n.codigoDeArticulo):n;t.append(`
                                        <div class="content-tr" data-identify="${u.pk_eProducto}" data-server="false">
                                            <div class="row">
                                                <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3 vertical-center-table">
                                                    <ul>
                                                        <li class="image-product">
                                                            <a href="javascript:void(0)"><img src="/Default/Storage?filename=${u.cFileName}" alt="" ></a>
                                                        </li>
                                                        <li class="name-product">
                                                            <span class="codigo-interno" style="display:none" data-codigo-interno="${u.cCodigoUno}" >N° Art. ${u.cCodigoUno}</span>  
                                                            <p class="stock-actual" style="font-size: 11px;display:none" data-stock-actual="${r.stock}">Stock actual : ${r.stock}</p>
                                                            <ul class="offers-product">
                                                                ${u.productoDescuento!=undefined?`
                                                                    <li>
																	    <div class="desct">
																		    <div class="line-left"></div>
																		    <!--<p>${u.productoDescuento.dValor} % <span>Dsc.</span></p>-->
																		    <div class="line-right"></div>
																	    </div>
																    </li>`:``}
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div class="col-lg-5 col-md-5 col-sm-6 col-xs-6 vertical-center-table">
                                                    <a href="/Producto/Details/${u.pk_eProducto}"><h5>${u.cProducto}</h5></a>
                                                    <div class="vertical-center-table text-center input-cant">
                                                        <div class="item__quantity__input text-left">
                                                            <p class="marca">${u.cMarca!=null?u.cMarca:u.cTipoProducto}</p>
                                                            <span class="cantidad-text"> Cantidad : </span>
                                                                <input type="number" class="text-left pr-0 iptCantidad" id="iptCantProducto" value="${f.eCantidad}" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2 vertical-center-table text-center bottom-vertical">
                                                    <p class="text-price" data-precio-final="${u.dPrecioVentaFinal}">S/${agregarCommaMillions((u.dPrecioVentaFinal*f.eCantidad).toFixed(2))}
                                                    <br>
                                                    <!--<span>${u.productoDescuento?u.cPrecioVenta:``}</span>--></p>
                                                </div>
                                                <div class="col-lg-2 col-md-2 hidden-sm hidden-xs vertical-center-table text-center  bottom-vertical" >
                                                    <p class="text-igv">Incl. IGV</p>
                                                </div>
                                                
                                            </div>
                                        </div>
                                        `)}})})}},complete:function(){r()}})):($("#table-cart").addClass("hidden"),$("#vacio-carrito").removeClass("hidden"),$(".cart-no").text("0"))}}function f(){t.length===1&&$.ajax({url:"/ShoppingCart/ListadoProductosEnCarrito",type:"GET",success:function(i){if(console.log(i),i.length>0){$("#table-cart").removeClass("hidden");$("#vacio-carrito").hasClass("hidden")||$("#vacio-carrito").addClass("hidden");t.html("");n=i;let r=i.map(n=>n.cCodigoUno).join();fetch(`/Producto/ConsultaStock?codigoInterno=${r}`).then(n=>n.json()).then(n=>{$.each(i,function(i,r){let u={};u=Array.isArray(n)?n.find(n=>r.cCodigoUno==n.codigoDeArticulo):n;t.append(`
                                    <div class="content-tr" data-identify="${r.fk_eProducto}" data-server="true">
                                        <div class="row">
                                            <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3 vertical-center-table">
                                                <ul>
                                                    <li class="image-product">
                                                        <a href="javascript:void(0)"><img src="/Default/Storage?filename=${r.cFileName}" alt="" ></a>
                                                    </li>
                                                    <li class="name-product">
                                                        <ul class="offers-product">
                                                            ${r.eDescuento>0?`
                                                                <li>
																	<div class="desct">
																		<div class="line-left"></div>
																		<p>${r.eDescuento} % <span>Dsc.</span></p>
																		<div class="line-right"></div>
																	</div>
																</li>`:``}
                                                        </ul>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="col-lg-5 col-md-4 col-sm-4 col-xs-4">
                                                <span class="codigo-interno" style="display:none" data-codigo-interno="${r.cCodigoUno}" >N° Art. ${r.cCodigoUno}</span>  
                                                <p class="stock-actual" style="font-size: 11px;display:none" data-stock-actual="${u.stock}">Stock actual : ${u.stock}</p>
                                            </div>
                                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 vertical-center-table">
                                                <a href="/Producto/Details/${r.fk_eProducto}"><h5>${r.cProducto}</h5></a>
                                                <span><a href="javascript:void(0)" style="color:red;" class="btnEliminar">Eliminar</a></span>
                                            </div>
                                             <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2 vertical-center-table text-center input-cant">
                                                <label class="mobile-text">Cantidad : </label>
                                                <div class="item__quantity">
                                                    <div class="item__quantity__input item__quantity__input__plus">
                                                        <button class="fa fa-minus deleteCantProduct" type="button"></button>
                                                        <input type="number" class="form-control pr-0 iptCantidad" id="iptCantProducto" value="${r.eCantidad}" readonly>
                                                        <button class="fa fa-plus addCantProduct" type="button"></button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2 vertical-center-table text-center">
                                                <p class="mobile-text">Precio : </p>
                                                <p class="text-price" data-precio-final="${r.dPrecioVentaFinal}">${r.cPrecioVentaFinal} 
                                                <br>
                                               <span>${r.productoDescuento?r.cPrecioVenta:``}</span></p>
                                            </div>
                                            <div class="col-lg-2 col-md-2 hidden-sm hidden-xs vertical-center-table text-center  bottom-vertical" >
                                                 <p class="text-igv">Incl. IGV</p>
                                            </div></div>
                                    </div>
                                    `)})});$(".loading").hide()}else $("#table-cart").addClass("hidden"),$("#vacio-carrito").removeClass("hidden"),$(".cart-no").text("0"),$(".loading").hide()}})}function i(){$.ajax({url:"/ShoppingCart/GetPurchaseInfo",type:"GET",success:function(n){$("#tdSubTotal").text(n.cPrecioSubTotal);$("#tdDescuento").text("-"+n.cPrecioDescuento);$("#tdPrecioEnvio").text(n.cPrecioEnvio);$("#tdTotal").text(n.cPrecioTotalMasEnvio);$(".loading").hide()}})}function r(){let u=mpolLocalStorage("mpol_carritotemporal").get(),i=0,t=0,r=0;n&&n.length>0?(n.forEach(n=>{let r=parseInt(u.find(t=>t.pk_eProducto==n.pk_eProducto).eCantidad);i+=parseFloat(n.dPrecioVenta)*r;t+=parseFloat(n.dPrecioVentaFinal)*r}),r=i-t,e(t).then(n=>{$(".subtotal").text(`S/${agregarCommaMillions(i.toFixed(2))}`),$("#tdDescuento").text(`-S/${agregarCommaMillions(r.toFixed(2))}`),$("#tdTotal").text(`S/${agregarCommaMillions((t+n).toFixed(2))}`),$("#tdPrecioEnvio").text(`S/${agregarCommaMillions(n.toFixed(2))}`),$(".loading").hide()})):($(".subtotal").text(`S/${agregarCommaMillions(i.toFixed(2))}`),$("#tdDescuento").text(`-S/${agregarCommaMillions(r.toFixed(2))}`),$("#tdTotal").text(`S/${agregarCommaMillions(t.toFixed(2))}`),$("#tdPrecioEnvio").text(`S/${agregarCommaMillions(0..toFixed(2))}`),$(".loading").hide())}function e(n){return fetch(`/ShoppingCart/ObtenerPrecioEnvio?dMontototal=${n}`).then(n=>n.json()).then(n=>n).catch(n=>console.warn(n))}const t=$("#listProductInCart");let n;$(document).ready(function(){$(".loading").show();$.ajax({url:"/Login/ValidateSession",type:"GET",success:function(n){n?f():u();$(".loading").hide()}})});$(document).on("click","#listProductInCart .input-cant .addCantProduct,.deleteCantProduct",function(){const f=$(this),n=$(this).parents(".item__quantity").find(".item__quantity__input").find(".iptCantidad"),t=$(this).parents(".content-tr").attr("data-identify"),s=parseInt($(this).parents(`div[data-identify='${t}']`).find(".stock-actual").attr("data-stock-actual")),h=$(this).parents(`div[data-identify='${t}']`).find(".codigo-interno").attr("data-codigo-interno"),e=$(this).parents(`div[data-identify='${t}']`).find(".text-total");let o=parseFloat($(this).parents(`div[data-identify='${t}']`).find(".text-price").attr("data-precio-final"));const u=f.hasClass("deleteCantProduct")?-1:1;fetch(`/Producto/ConsultaStock?codigoInterno=${h}`).then(n=>n.json()).then(h=>{parseInt(n.val())<parseInt(h.stock)&&f.hasClass("addCantProduct")?$.ajax({url:"/Login/ValidateSession",type:"GET",success:function(h){h?$.ajax({url:"/ShoppingCart/Agregar",data:{pk_eProducto:f.parents(".content-tr").attr("data-identify"),eCantidad:u},type:"POST",success:function(t){if(t.Success){let t=parseInt(n.val())+u;n.val(t);e.text(`S/${agregarCommaMillions((o*t).toFixed(2))}`);i()}else console.log("Error..."+t.MessageError);$(".loading").hide()}}):($.each(mpolLocalStorage("mpol_carritotemporal").get(),function(i,r){if(r.pk_eProducto===t){let t=parseInt(n.val())+u;t<=s&&(r.eCantidad=t,mpolLocalStorage("mpol_carritotemporal").set(i,r),n.val(t),e.text(`S/${agregarCommaMillions((o*t).toFixed(2))}`))}}),r(),$(".loading").hide())},beforeSend:function(){$(".loading").show()}}):f.hasClass("deleteCantProduct")&&parseInt(n.val())>1&&$.ajax({url:"/Login/ValidateSession",type:"GET",success:function(s){s?$.ajax({url:"/ShoppingCart/Agregar",data:{pk_eProducto:f.parents(".content-tr").attr("data-identify"),eCantidad:u},type:"POST",success:function(t){if(t.Success){let t=parseInt(n.val())+u;n.val(t);e.text(`S/${agregarCommaMillions((o*t).toFixed(2))}`);i()}else console.log("Error..."+t.MessageError);$(".loading").hide()}}):(parseInt(n.val())>1&&($.each(mpolLocalStorage("mpol_carritotemporal").get(),function(i,r){if(r.pk_eProducto===t){let t=parseInt(n.val())+u;r.eCantidad=t;mpolLocalStorage("mpol_carritotemporal").set(i,r);n.val(t);e.text(`S/${agregarCommaMillions((o*t).toFixed(2))}`)}}),r()),$(".loading").hide())},beforeSend:function(){$(".loading").show()}})})});$("#chktermOfService").on("change",function(){$(this).is(":checked")?($("#btnCheckOutFinish").prop("disabled",!1),$("#msg-termOfService").hide()):($("#btnCheckOutFinish").prop("disabled",!0),$("#msg-termOfService").show())});$("#listProductInCart").on("click",".btnEliminar",function(){$(".loading").show();const t=$(this).parents(".content-tr"),f=t.attr("data-identify"),e=t.attr("data-server")==="true"?!0:!1;if(e)$.ajax({url:"/ShoppingCart/Eliminar/"+f,type:"POST",success:function(n){n.Success?(t.remove(),mpolRefreshItem(!0),i(),document.location.reload(!0)):console.log("Error..."+n.MessageError)},complete:function(){$(".loading").hide()}});else{const i=mpolLocalStorage("mpol_carritotemporal").get();$.each(i,function(i,e){e.pk_eProducto==f&&(mpolLocalStorage("mpol_carritotemporal").delete(i),t.remove(),mpolRefreshItem(!1),n=n.filter(n=>n.pk_eProducto!=f),u(),r(),$(".loading").hide())})}});$("#btnEmptyCart").on("click",function(){$(".loading").show();const n=$(".content-tr"),t=n.attr("data-server")=="false"?!1:!0;t?$.ajax({url:"/ShoppingCart/EliminarPedido/"+$("#pk_ePedido").val(),type:"POST",success:function(n){n.Success?(localStorage.setItem("mpol_carritotemporal",[]),$("#listProductInCart .content-tr").remove(),mpolRefreshItem(!1),i()):console.log("Error..."+n.MessageError)},complete:function(){$(".loading").hide();document.location.reload(!0)}}):(localStorage.setItem("mpol_carritotemporal",[]),$("#listProductInCart .content-tr").remove(),$("#listProductInCart").append(`
                                    <div class="d-flex justify-content-center align-items-center">
                                        <div class="row">
                                            <label align="center">No tienes productos en tu carrito</label>
                                        </div>
                                    </div> `),mpolRefreshItem(!1),u(),$(".loading").hide())});$("#btnCheckOutFinish").on("click",function(){$.ajax({url:"/Login/ValidateSession",type:"GET",success:function(n){if(n){const n=parseInt(document.querySelector(".cart-no").textContent);n>0?window.location.href="/CheckOut":window.location.reload()}else window.location.href="/Login/Index"}})})});