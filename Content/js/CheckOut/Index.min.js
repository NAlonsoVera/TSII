var OnSuccessGuardarImagenPedido,OnFailureGuardarImagenPedido;$(function(){function ut(){let t=e.value.length;const n=document.querySelector(".messageRucInvalido");t===11?b(!0,"",n):b(!1,"Ruc inválido",n)}function ft(t){const i=document.querySelectorAll("#datosFacturacion .col-sm-6");i.forEach(n=>n.classList.remove("d-none"));t.target.classList.add("d-none");f.classList.add("d-none");n.classList.remove("d-none");n.removeAttribute("disabled");h.classList.remove("d-none")}function et(){const i=new FormData,u=document.querySelector("#pk_ePedido").value,t=parseInt(document.querySelector("input[name='medioPago']:checked").value),f=parseInt(document.querySelector("input[name='metodoPago']:checked").value),r=document.querySelector("#direccionContenido").dataset.pkclientedireccion,e=document.querySelector("#chkSolicitarFactura").checked,o=parseFloat(document.querySelector("#tdPrecioEnvio").dataset.precioenvio),n={fk_eMedioPago:null,fk_eMetodoPago:null,dMontoEfectivo:null,fk_eClienteDireccionEnvio:null,fk_eEstadoPedido:7,pk_ePedido:u,dPrecioEnvio:o};if(t!==MedioPago.PagoContraEntrega&&t!==MedioPago.TarjetaCreditoDebito){let n=document.getElementById("himage").files[0];if(n)i.append("himage",n);else{Swal.fire("Faltan Datos!","Debe adjuntar una imagen del pago realizado!","info");return}}if(t===MedioPago.TarjetaCreditoDebito&&!$("#terminos_niubiz").is(":checked")){Swal.fire("Faltan Datos!","Debe aceptar los términos y condiciones!","info");return}if(e){const t=l();if(t.cRazonSocial===""||t.cNumeroRuc===""||t.cDireccionFiscal===""||t.cTelefonoContacto===""){Swal.fire("Faltan Datos!","Debe ingresar los datos de Facturación!","error");return}n.cNumeroRuc=t.cNumeroRuc;n.cRazonSocial=t.cRazonSocial;n.cDireccionFiscal=t.cDireccionFiscal;n.cTelefonoContacto=t.cTelefonoContacto}if(n.fk_eClienteDireccionEnvio=r,n.fk_eMedioPago=t,t===MedioPago.PagoContraEntrega&&(n.fk_eMetodoPago=f),n.fk_eClienteDireccionEnvio===null||r===""){Swal.fire("Faltan Datos!","Debe ingresar una dirección de envio!","error");return}Swal.fire({title:"Falta poco!!",text:"¿Estas seguro de finalizar tu pedido?",type:"question",showCancelButton:!0,confirmButtonColor:"#755C78",cancelButtonColor:"#B2B2B2",confirmButtonText:"Si",cancelButtonText:"No"}).then(t=>{t.value&&(n.fk_eMedioPago===MedioPago.TarjetaCreditoDebito?Culqi.open():ot(n,i))})}function ot(n,t){Object.keys(n).forEach(i=>{t.append(i,n[i])});fetch(`/CheckOut/FinalizarPedido`,{method:"POST",contentType:!1,processData:!1,body:t,headers:{enctype:"multipart/form-data"}}).then(n=>n.json()).then(n=>{n.Success?Swal.fire({html:'<img src="/Content/image/finalizacionCompra.png">',showCancelButton:!0,confirmButtonColor:"#fff",cancelButtonColor:"#fff",confirmButtonText:"Ir a mis pedidos",cancelButtonText:"Ir a home",allowOutsideClick:!1}).then(n=>{$(".loading").show(),window.location.href=n.value?"/Perfil":"/"}):console.log(n.MessageError),$(".loading").hide()})}function b(n,t,i){const r=i;n?r.classList.add("d-none"):r.classList.remove("d-none");r.textContent=t}function st(){$(".loading").show();invocarModal(`/Perfil/PartialDireccionMant/`,function(){$(".loading").hide();$("#modalDireccionesMant").on("hidden.bs.modal",function(){document.querySelector("#cDireccion").value!==""&&c(null,!0)})})}function c(n,f){const e=document.querySelector("#direccionContenido");fetch(`/Perfil/BuscarDireccionEnvio?pk_eClienteDireccionEnvio=${n}&pk_ePedido=${$("#pk_ePedido").val()}`).then(n=>n.json()).then(n=>{const{cDireccion:h,cDistrito:c,cDepartamento:l,cProvincia:a,cReferencia:o,cTelefono:s,pk_eClienteDireccionEnvio:v}=n;e.innerHTML="";e.dataset.pkclientedireccion=v;e.innerHTML=`
                    <p>
                        <h5><i class="fa fa-map-marker" aria-hidden="true"></i> Dirección de envio</h5>
                        <br />
                        <span>${h}                                                          </span><br />
                        ${o?"<span>"+o+"<\/span><br />":""}                          
                        <span> ${l} - ${a} - ${c}                       </span><br />
                        ${s?"<span>Teléfono:"+s+"<\/span><br />":""}           
                    </p>
                `;t.classList.remove("d-none");i.classList.remove("d-none");r.classList.add("d-none");u.classList.add("d-none");f&&k(!0)})}function ht(){const n=document.querySelector("#direccionContenido");t.classList.add("d-none");i.classList.add("d-none");r.classList.remove("d-none");u.classList.remove("d-none");fetch(`/Perfil/ListadoDireccion`).then(n=>n.json()).then(t=>{n.innerHTML="";n.innerHTML=`<p><h5>Seleccione una dirección de envio</h5></p>`;const i=document.createElement("select");i.classList.add("form-control","selectDireccioneEnvio");i.innerHTML+="<option value=''><\/option>";t.data.forEach(n=>{const{cDireccion:t,cDistrito:r,pk_eClienteDireccionEnvio:u}=n;i.innerHTML+=`
                        <option value=${u}> ${r} - ${t}  </option>
                        `});n.appendChild(i)})}function ct(){const n=document.querySelector(".selectDireccioneEnvio").value;n!==""&&(t.classList.remove("d-none"),i.classList.remove("d-none"),r.classList.add("d-none"),u.classList.add("d-none"),c(parseInt(n),!0))}function lt(){const n=document.querySelector("#direccionContenido").dataset.pkclientedireccion;t.classList.remove("d-none");i.classList.remove("d-none");r.classList.add("d-none");u.classList.add("d-none");c(parseInt(n),!1)}function k(){$(".loading").show();const n=document.querySelector("#direccionContenido").dataset.pkclientedireccion,{cRazonSocial:t,cNumeroRuc:i,cDireccionFiscal:r,cTelefonoContacto:u}=l(),f={fk_eClienteDireccionEnvio:n,cRazonSocial:t,cNumeroRuc:i,cDireccionFiscal:r,cTelefonoContacto:u};fetch(`/CheckOut/ActualizarDatosPedido`,{method:"POST",body:JSON.stringify(f),headers:{"Content-Type":"application/json"}}).then(n=>n.json()).then(n=>{n.Success&&$(".loading").hide(),window.location.href="/CheckOut"}).catch(n=>{$(".loading").hide(),console.log(n),Swal.fire("Error!","Ocurrió un error al guardar la información","error")})}function at(n){const t=document.querySelector("#datosFacturacion");n.target.checked?t.classList.remove("d-none"):t.classList.add("d-none")}function vt(){k();d()}function d(){const t=document.querySelectorAll("#datosFacturacion .col-sm-6");t.forEach(n=>n.classList.add("d-none"));n.classList.add("d-none");f.classList.remove("d-none");v.classList.remove("d-none");h.classList.add("d-none");f.innerHTML="";f.innerHTML=`
                <p>
                    <span><strong>Razón Social:</strong> ${p.value}</span> <br />
                    <span><strong>Ruc:</strong> ${e.value}</span> <br />
                    <span><strong>Dirección Fiscal:</strong> ${y.value}</span> <br />
                    <span><strong>Teléfono:</strong>  ${w.value}</span> <br />
                </p>
            `}function yt(){d()}function l(){const n=document.querySelector("#cRazonSocial").value,t=document.querySelector("#cNumeroRuc").value,i=document.querySelector("#cDireccionFiscal").value,r=document.querySelector("#cTelefonoContacto").value;return{cRazonSocial:n,cNumeroRuc:t,cDireccionFiscal:i,cTelefonoContacto:r}}function o(){const t=l(),i=Object.values(t).every(n=>n!=="")&&t.cNumeroRuc.length==11;i?n.removeAttribute("disabled"):n.setAttribute("disabled","true")}function g(){s.innerHTML="";fetch(`/CheckOut/ObtenerPedido`).then(n=>n.json()).then(n=>{const t=n.LsPedidoProducto;if(t.length>0){let n=t.map(n=>n.cCodigoUno).join();fetch(`/Producto/ConsultaStock?codigoInterno=${n}`).then(n=>n.json()).then(n=>{t.forEach(t=>{console.log(t);const{fk_eProducto:i,cFileName:o,cProducto:r,cCodigoUno:h,eDescuento:u,eCantidad:f,cMarca:c,dPrecioVentaFinal:l}=t;let e={};e=Array.isArray(n)?n.find(n=>h==n.codigoDeArticulo):n;s.innerHTML+=`
                        <div class="content-tr" data-identify="${i}" data-server="true">
                            <div class="row">
                                <div class="col-lg-3 col-md-4 col-sm-3 col-xs-3 vertical-center-table">
                                    <ul>
                                        <li class="image-product" style="text-align:center">
                                            <a href="/Producto/Details/${i}"><img src="/Default/Storage?filename=${o}" alt="${r}"></a>
                                        </li>
                                        <li class="name-product">  
                                            <ul class="offers-product">
                                                ${u>0?`           <li>
                                                        <div class="desct">
                                                            <div class="line-left"></div>
                                                            <!--<p>${u} % <span>Dsc.</span></p>-->
                                                            <div class="line-right"></div>
                                                        </div>
                                                    </li>`:""}
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-lg-5 col-md-5 col-sm-6 col-xs-6">
                                    <a href="/Producto/Details/${i}"> <h5>${r}</h5> </a>
                                    <div class="vertical-center-table text-center input-cant">
                                        <div class="item__quantity text-left">
                                            <p class="marca">${c}</p>
                                            <div class="item__quantity__input text-left">
                                                <span class="cantidad-text"> Cantidad : </span>
                                                <input type="number" class="text-left pr-0 iptCantidad" id="iptCantProducto" value="${f}" data-stockactual="${e.stock}" readonly>
                                                <span class="input-group-btn item__quantity__input__plus">
                                                    <button class="fa fa-plus addCantProduct" type="button" data-fkproducto="${i}"></button>
                                                    <div class="clearfix"></div>
                                                    <button class="fa fa-minus deleteCantProduct" type="button" data-fkproducto="${i}"></button>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>`+`<div class="col-lg-2 col-md-2 col-sm-2 col-xs-2 vertical-center-table text-center bottom-vertical">
                                    <p class="text-total">S/${agregarCommaMillions((l*f).toFixed(2))} </p>
                                </div>
                                <div class="col-lg-2 col-md-2 hddien-sm hidden-xs vertical-center-table text-center  bottom-vertical" >
                                    <p class="text-igv">Incl. IGV</p>
                                </div>`+`</div>
                        </div>`})})}else window.location.href="/ShoppingCart"}).catch(n=>console.log(n))}function nt(){fetch(`/ShoppingCart/GetPurchaseInfo`).then(n=>n.json()).then(n=>{const{cPrecioSubTotal:r,cPrecioDescuento:u,cPrecioTotalMasEnvio:f,dPrecioTotalMasEnvio:e,cPrecioEnvio:o,dPrecioEnvio:s}=n,h=document.querySelector("#tdSubTotal"),c=document.querySelector("#tdDescuento"),t=document.querySelector("#tdPrecioEnvio"),i=document.querySelector("#tdTotal");h.textContent=r;c.textContent="-"+u;t.textContent=o;t.dataset.precioenvio=s;i.textContent=f;i.dataset.total=e}).catch(n=>{console.log(n)})}function pt(n){const t=n.target.parentElement.parentElement.querySelector("#iptCantProducto");if(n.target.classList.contains("btnEliminar")){const t={id:parseInt(n.target.dataset.fkproducto)};wt(t)}else if(n.target.classList.contains("addCantProduct")){const t=n.target.parentElement.parentElement.querySelector("#iptCantProducto"),i=parseInt(t.dataset.stockactual);if(parseInt(t.value)+1<=i){const t={pk_eProducto:parseInt(n.target.dataset.fkproducto),eCantidad:1};tt(t,n)}else $(".loading").hide()}else if(n.target.classList.contains("deleteCantProduct")){const t=parseInt(n.target.parentElement.parentElement.querySelector("#iptCantProducto").value);if(t>1){const t={pk_eProducto:parseInt(n.target.dataset.fkproducto),eCantidad:-1};tt(t,n)}else $(".loading").hide()}}function wt(n){$(".loading").show();fetch(`/ShoppingCart/Eliminar/`,{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json"}}).then(n=>n.json()).then(n=>{n.Success?(g(),mpolRefreshItem(!0),nt()):console.log("Error..."+result.MessageError),$(".loading").hide()}).catch(n=>{$(".loading").hide(),console.log(n)})}function tt(n,t){$(".loading").show();const i=t.target.parentElement.parentElement.querySelector("#iptCantProducto"),r=t.target.parentElement.parentElement.parentElement.parentElement.parentElement.querySelector(".text-total"),u=t.target.parentElement.parentElement.parentElement.parentElement.parentElement.querySelector(".text-price").dataset.preciofinal;fetch(`/ShoppingCart/Agregar`,{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json"}}).then(n=>n.json()).then(t=>{if(t.Success){let t=parseInt(i.value)+n.eCantidad;i.value=t;r.textContent=`S/${agregarCommaMillions((parseFloat(u)*t).toFixed(2))}`;nt()}else console.log("Error..."+result.MessageError);$(".loading").hide()}).catch(n=>{$(".loading").hide(),console.log(n)})}const bt=document.querySelector("#direccionEnvioContenido"),kt=document.querySelector("#metodoPagoContenido"),dt=document.querySelector("#facturacionContenido"),s=document.querySelector("#listProductInCart"),f=document.querySelector("#facturacionContenidoCuerpo"),a=document.querySelector(".imagenPago"),gt=$("#frmGuardarImagenPedido"),t=document.querySelector(".btnAgregarDireccion"),i=document.querySelector(".btnCambiarDireccion"),r=document.querySelector(".btnGuardarCambiosDireccion"),u=document.querySelector(".btnCancelarSeleccionDireccion"),n=document.querySelector(".btnGuardarCambiosFacturacion"),v=document.querySelector(".btnEditarDatosFacturacion"),h=document.querySelector(".btnCancelarCambioFacturacion"),it=document.querySelector(".btnFinalizarCompra"),rt=document.querySelector("#chkSolicitarFactura"),e=document.querySelector("#cNumeroRuc"),y=document.querySelector("#cDireccionFiscal"),p=document.querySelector("#cRazonSocial"),w=document.querySelector("#cTelefonoContacto");t.addEventListener("click",st);i.addEventListener("click",ht);r.addEventListener("click",ct);u.addEventListener("click",lt);n.addEventListener("click",vt);it.addEventListener("click",et);v.addEventListener("click",ft);h.addEventListener("click",yt);rt.addEventListener("change",at);e.addEventListener("keyup",o);e.addEventListener("change",ut);y.addEventListener("keyup",o);w.addEventListener("keyup",o);p.addEventListener("keyup",o);s.addEventListener("click",pt);g();OnSuccessGuardarImagenPedido=function(n){n.Success?($("#btnGuardarImagen").attr("disabled",!0),Swal.fire("Bien!","Imagen Guardada Correctamente","success")):Swal.fire("Algo Salio Mal!",n.MessageError?n.MessageError:"Ha ocurrido un error inesperado","error")};OnFailureGuardarImagenPedido=function(){swal("Algo Salio Mal!","Ocurrio un error al Guardar","error")};$("#himage").fileinput({showRemove:!1,browseClass:"btn btn-primary btn-block",showUpload:!1,showCaption:!1,allowedFileExtensions:["png","jpeg","jpg"],maxFileCount:1,maxFileSize:5120}).on("fileloaded",function(){$("#btnGuardarImagen").attr("disabled",!1)}).on("fileclear",function(){$("#btnGuardarImagen").attr("disabled",!0);$(this).fileinput("enable")}).on("fileerror",function(){swal("Algo Salio Mal!",data.MessageError,"error");$("#himage").fileinput("clear")});$("#himage").attr("data-preimagen")&&($("#himage").fileinput("refresh",{initialPreview:[`${URLBlobStorage}${$frmProductoMant.find("#himage").attr("data-preimagen")}`],initialPreviewAsData:!0}),$("#himage").fileinput("disable"));$(".btn-file").find("span.hidden-xs").hasClass("textoImagenAdjunto")||$(".btn-file").find("span.hidden-xs").addClass("textoImagenAdjunto");$(".btn-file").find("span.textoImagenAdjunto").text("Adjuntar Imagen");$(".btn-file").find("span.textoImagenAdjunto").removeClass("hidden-xs");$(".opc__item .collapse").on("hide.bs.collapse",function(){$(this).parents(".opc__item").removeClass("allow")});$(".opc__item .collapse").on("show.bs.collapse",function(){$(this).parents(".opc__item").addClass("allow")});$("input[type=radio][data-tab]").on("click",function(){const n=$(this);if(parseInt(n.val())===MedioPago.PagoContraEntrega?a.classList.add("hide"):a.classList.remove("hide"),n.is(":checked")){const t=$(n.attr("data-tab")),i=t.parent();i.find("div.tab-pane").removeClass("active");t.addClass("active")}})});