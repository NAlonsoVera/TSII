$(function(){function u(){if(t.length===1){let r=mpolLocalStorage("mpol_carritotemporal").get();r&&r.length!==0&&$.ajax({url:"/Producto/ListadoFiltro",data:{productos:r},type:"POST",success:function(i){if(i){t.html("");n=i;let u=i.map(n=>n.cCodigoUno).join();fetch(`/Producto/ConsultaStock?codigoInterno=${u}`).then(n=>n.json()).then(n=>{$.each(i,function(i,u){if(r.some(n=>n.pk_eProducto==u.pk_eProducto)){let f=r.find(n=>n.pk_eProducto==u.pk_eProducto),i={};i=Array.isArray(n)?n.find(n=>u.cCodigoUno==n.codigoDeArticulo):n;t.append(`
                                        <div class="content-tr" data-identify="${u.pk_eProducto}" data-server="false">
                                            <div class="row"><div class="col-md-12 text-left cart-title cart-title12"><a class="title-product-cart" href="/Producto/Details/${u.pk_eProducto}">${u.cProducto}</a></div></div>
                                            <div class="row" style="margin-left:-5px;">
                                                <div class="col-lg-5 col-md-5 col-sm-12 col-xs-12 vertical-center-table p-0">
                                                    <ul>
                                                        <li class="image-product">
                                                            <a href="javascript:void(0)"><img src="/Default/Storage?filename=${u.cFileName}" style="width:100%" alt="" ></a>
                                                        </li>
                                                        <li class="name-product text-center">
                                                            <span class="codigo-interno" data-codigo-interno="${u.cCodigoUno}" style="display:none" >N° Art. ${u.cCodigoUno}</span>  
                                                            <p class="stock-actual" style="font-size: 11px;display:none" data-stock-actual="${i.stock}">Stock actual : ${i.stock}</p>
                                                            <ul class="offers-product">
                                                                ${u.productoDescuento!=undefined?`
                                                                    <li>
																	    <div class="desct">
																		    <div class="line-left"></div>
																		    <!--<p>${u.productoDescuento.dValor} % <span>Dsc.</span></p>-->
																		    <div class="line-right"></div>
																	    </div>
																    </li>`:``}
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div class="col-lg-5 col-md-5 col-sm-4 col-xs-4  text-left input-cant" style="font-size: 14px;padding-top:25px;">
<p style="margin-bottom: 10px; font-size: 12px; color: #616D70; font-weight:600; text-transform: uppercase">${u.cMarca!=null?u.cMarca:u.cCategoria}</p>
                                                    <div class="item__quantity__input__plus" style="margin-bottom:10px">
                                                        <button class="fa fa-minus deleteCantProduct-${modal}" type="button"></button>
                                                        <input type="number" class="form-control iptCantidad pr-0" id="iptCantProducto" value="${f.eCantidad}" readonly>
                                                        <button class="fa fa-plus addCantProduct-${modal} type="button"></button>
                                                    </div>
<p><a href="javascript:void(0)" style="color:#000;text-decoration: underline;font-size:14px;" class="btnEliminar">Remover</a></p>
                                                </div>
                                                <div class="col-lg-2 col-md-2 col-sm-4 col-xs-4 vertical-center-table text-center" style="display: flex;align-items: center;padding:0;">
                                                    <p class="text-price" style="font-weight: bold;font-size:14px;" data-precio-final="${u.dPrecioVentaFinal}">S/${agregarCommaMillions((u.dPrecioVentaFinal*f.eCantidad).toFixed(2))}
                                                    <br>
                                                    <!--<span>${u.productoDescuento?u.cPrecioVenta:``}</span>--></p>
                                                </div>
                                            </div>
                                        </div>
                                        `)}})})}},complete:function(){i()}})}else $(".cart-no").text("0")}function e(){t.length===1&&$.ajax({url:"/ShoppingCart/ListadoProductosEnCarrito",type:"GET",success:function(i){if(i.length>0){t.html("");n=i;let r=i.map(n=>n.cCodigoUno).join();fetch(`/Producto/ConsultaStock?codigoInterno=${r}`).then(n=>n.json()).then(n=>{$.each(i,function(i,r){let u={};u=Array.isArray(n)?n.find(n=>r.cCodigoUno==n.codigoDeArticulo):n;t.append(`
                                    <div class="content-tr" data-identify="${r.fk_eProducto}" data-server="true">
                                        <div class="row"><div class="col-md-12 text-left cart-title cart-title12"><a class="title-product-cart" href="/Producto/Details/${r.fk_eProducto}">${r.cProducto}</a></div></div>
                                        <div class="row" style="margin-left:-5px;">
                                            <div class="col-lg-5 col-md-5 col-sm-12 col-xs-12 vertical-center-table p-0">
                                                <ul>
                                                    <li class="image-product">
                                                        <a href="javascript:void(0)"><img src="/Default/Storage?filename=${r.cFileName}" alt="" ></a>
                                                    </li>
                                                    <li class="name-product">
                                                        <span class="codigo-interno" data-codigo-interno="${r.cCodigoUno}" style="display:none" >N° Art. ${r.cCodigoUno}</span>  
                                                        <p class="stock-actual" style="font-size: 11px;display:none" data-stock-actual="${u.stock}">Stock actual : ${u.stock}</p>
                                                        <ul class="offers-product">
                                                            ${r.eDescuento>0?`
                                                                <li>
																	<div class="desct">
																		<div class="line-left"></div>
																		<!--<p>${r.eDescuento} % <span>Dsc.</span></p>-->
																		<div class="line-right"></div>
																	</div>
																</li>`:``}
                                                        </ul>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="col-lg-5 col-md-5 col-sm-4 col-xs-4  text-left input-cant" style="font-size: 14px;padding-top:25px;">
<p style="margin-bottom: 10px; font-size: 12px; color: #616D70; font-weight:600;text-transform: uppercase">${r.cMarca}</p>
                                                <div class="item__quantity__input__plus">
                                                    <button class="fa fa-minus deleteCantProduct-${modal}" type="button"></button>
                                                    <input type="number" class="form-control iptCantidad pr-0" id="iptCantProducto" value="${r.eCantidad}" readonly>
                                                    <button class="fa fa-plus addCantProduct-${modal}" type="button"></button>
                                                </div>
                                                <span><a href="javascript:void(0)" style="color:#000;text-decoration: underline;font-size:14px;" class="btnEliminar">Remover</a></span>
                                            </div>
                                            <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12 vertical-center-table text-center p-0" style="display: flex;align-items: center;paddgin:0;">
                                                <p class="text-price" style="font-weight: bold;font-size:14px;"  data-precio-final="${r.dPrecioVentaFinal}">S/${agregarCommaMillions((r.dPrecioVentaFinal*r.eCantidad).toFixed(2))}
                                                <br>
                                               <!--<span>${r.productoDescuento?r.cPrecioVenta:``}</span>-->
</p>
                                            </div>
                                        </div>
                                    </div>
                                    `)})});$(".loading").hide()}else console.log("sss"),$(".loading").hide()}})}function r(){$.ajax({url:"/ShoppingCart/GetPurchaseInfo",type:"GET",success:function(n){$("#tdSubTotal").text(n.cPrecioSubTotal);$("#tdDescuento").text("-"+n.cPrecioDescuento);$("#tdPrecioEnvio").text(n.cPrecioEnvio);$("#tdTotal").text(n.cPrecioTotalMasEnvio);$(".loading").hide()}})}function i(){let u=mpolLocalStorage("mpol_carritotemporal").get(),t=0,i=0,r=0;n&&n.length>0?(n.forEach(n=>{let r=parseInt(u.find(t=>t.pk_eProducto==n.pk_eProducto).eCantidad);t+=parseFloat(n.dPrecioVenta)*r;i+=parseFloat(n.dPrecioVentaFinal)*r}),r=t-i):($(".subtotal").text(`S/${agregarCommaMillions(t.toFixed(2))}`),$("#tdDescuento").text(`-S/${agregarCommaMillions(r.toFixed(2))}`),$("#tdTotal").text(`S/${agregarCommaMillions(i.toFixed(2))}`),$("#tdPrecioEnvio").text(`S/${agregarCommaMillions(0..toFixed(2))}`),$(".loading").hide());$(".subtotal").text(`S/${agregarCommaMillions(t.toFixed(2))}`);$("#tdDescuento").text(`-S/${agregarCommaMillions(r.toFixed(2))}`);$("#tdTotal").text(`S/${agregarCommaMillions(i.toFixed(2))}`);$("#tdPrecioEnvio").text(`S/${agregarCommaMillions(0..toFixed(2))}`);$(".loading").hide()}modal+=1;const t=$("#listProductInCart");let n;$(".loading").show();$.ajax({url:"/Login/ValidateSession",type:"GET",success:function(n){n?e():u();$(".loading").hide()}});$(document).on("click","#listProductInCart .input-cant .addCantProduct-"+modal+", .deleteCantProduct-"+modal+" ",function(){const f=$(this),n=$(this).parents(".item__quantity__input__plus").find(".iptCantidad"),t=$(this).parents(".content-tr").attr("data-identify"),s=parseInt($(this).parents(`div[data-identify='${t}']`).find(".stock-actual").attr("data-stock-actual")),h=$(this).parents(`div[data-identify='${t}']`).find(".codigo-interno").attr("data-codigo-interno"),e=$(this).parents(`div[data-identify='${t}']`).find(".text-price");let o=parseFloat($(this).parents(`div[data-identify='${t}']`).find(".text-price").attr("data-precio-final"));const u=f.hasClass("deleteCantProduct-"+modal)?-1:1;fetch(`/Producto/ConsultaStock?codigoInterno=${h}`).then(n=>n.json()).then(h=>{parseInt(n.val())<parseInt(h.stock)&&f.hasClass("addCantProduct-"+modal)?$.ajax({url:"/Login/ValidateSession",type:"GET",success:function(h){h?$.ajax({url:"/ShoppingCart/Agregar",data:{pk_eProducto:f.parents(".content-tr").attr("data-identify"),eCantidad:u},type:"POST",success:function(t){if(t.Success){let t=parseInt(n.val())+u;n.val(t);e.text(`S/${agregarCommaMillions((o*t).toFixed(2))}`);r()}else swal.fire("Advertencia!",t.MessageError,"error");$(".loading").hide()}}):($.each(mpolLocalStorage("mpol_carritotemporal").get(),function(i,r){if(r.pk_eProducto===parseInt(t)){let t=parseInt(n.val())+u;t<=s&&(r.eCantidad=t,mpolLocalStorage("mpol_carritotemporal").set(i,r),n.val(t),e.text(`S/${agregarCommaMillions((o*t).toFixed(2))}`))}}),i(),$(".loading").hide())},beforeSend:function(){$(".loading").show()}}):f.hasClass("deleteCantProduct-"+modal)&&parseInt(n.val())>1&&$.ajax({url:"/Login/ValidateSession",type:"GET",success:function(s){s?$.ajax({url:"/ShoppingCart/Agregar",data:{pk_eProducto:f.parents(".content-tr").attr("data-identify"),eCantidad:u},type:"POST",success:function(t){if(t.Success){let t=parseInt(n.val())+u;n.val(t);e.text(`S/${agregarCommaMillions((o*t).toFixed(2))}`);r()}else swal.fire("Advertencia!",t.MessageError,"error");$(".loading").hide()}}):(parseInt(n.val())>1&&($.each(mpolLocalStorage("mpol_carritotemporal").get(),function(i,r){if(r.pk_eProducto===parseInt(t)){let t=parseInt(n.val())+u;r.eCantidad=t;mpolLocalStorage("mpol_carritotemporal").set(i,r);n.val(t);e.text(`S/${agregarCommaMillions((o*t).toFixed(2))}`)}}),i()),$(".loading").hide())},beforeSend:function(){$(".loading").show()}})})});$("#listProductInCart").on("click",".btnEliminar",function(){$(".loading").show();const t=$(this).parents(".content-tr"),f=t.attr("data-identify"),e=t.attr("data-server")==="true"?!0:!1;if(e)$.ajax({url:"/ShoppingCart/Eliminar/"+f,type:"POST",success:function(n){n.Success?(t.remove(),mpolRefreshItem(!0),r(),document.location.reload(!0)):swal.fire("Advertencia!",n.MessageError,"error")},complete:function(){$(".loading").hide()}});else{const r=mpolLocalStorage("mpol_carritotemporal").get();$.each(r,function(r,e){e.pk_eProducto==f&&(mpolLocalStorage("mpol_carritotemporal").delete(r),t.remove(),mpolRefreshItem(!1),n=n.filter(n=>n.pk_eProducto!=f),u(),i(),$(".loading").hide())})}});var f=$("#ModalConfirmed");f.on("hidden.bs.modal",function(){$(this).parent().remove()});f.modal("show")});